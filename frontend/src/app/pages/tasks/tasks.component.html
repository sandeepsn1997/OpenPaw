<div class="page-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-row">
      <div>
        <h1>Tasks</h1>
        <p>Schedule, track and manage your automated tasks</p>
      </div>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <span class="material-symbols-rounded" style="font-size: 18px;">add_task</span>
        New Task
      </button>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="stats-row">
    <div class="mini-stat" [class.active]="activeFilter() === 'all'" (click)="setFilter('all')">
      <span class="mini-stat-count">{{ getStatCount('all') }}</span>
      <span class="mini-stat-label">Total</span>
    </div>
    <div class="mini-stat" [class.active]="activeFilter() === 'pending'" (click)="setFilter('pending')">
      <div class="mini-stat-dot amber"></div>
      <span class="mini-stat-count">{{ getStatCount('pending') }}</span>
      <span class="mini-stat-label">Pending</span>
    </div>
    <div class="mini-stat" [class.active]="activeFilter() === 'in_progress'" (click)="setFilter('in_progress')">
      <div class="mini-stat-dot blue"></div>
      <span class="mini-stat-count">{{ getStatCount('in_progress') }}</span>
      <span class="mini-stat-label">Running</span>
    </div>
    <div class="mini-stat" [class.active]="activeFilter() === 'completed'" (click)="setFilter('completed')">
      <div class="mini-stat-dot emerald"></div>
      <span class="mini-stat-count">{{ getStatCount('completed') }}</span>
      <span class="mini-stat-label">Done</span>
    </div>
    <div class="mini-stat" [class.active]="activeFilter() === 'failed'" (click)="setFilter('failed')">
      <div class="mini-stat-dot rose"></div>
      <span class="mini-stat-count">{{ getStatCount('failed') }}</span>
      <span class="mini-stat-label">Failed</span>
    </div>
  </div>

  <!-- Search & View Bar -->
  <div class="search-view-bar">
    <div class="search-bar">
      <span class="material-symbols-rounded search-icon">search</span>
      <input class="input search-input" [ngModel]="searchQuery()"
        (ngModelChange)="searchQuery.set($event); onSearchChange()" placeholder="Search tasks..." />
    </div>

    <div class="view-switcher">
      <button class="switcher-btn" [class.active]="viewMode() === 'list'" (click)="viewMode.set('list')"
        title="List View">
        <span class="material-symbols-rounded">view_list</span>
        List
      </button>
      <button class="switcher-btn" [class.active]="viewMode() === 'board'" (click)="viewMode.set('board')"
        title="Board View">
        <span class="material-symbols-rounded">view_kanban</span>
        Board
      </button>
    </div>
  </div>

  <!-- Task Content -->
  @if (loading()) {
  <div class="loading-state">
    <span class="material-symbols-rounded animate-pulse" style="font-size: 32px;">hourglass_top</span>
    <p>Loading tasks...</p>
  </div>
  } @else if (filteredTasks().length === 0) {
  <div class="empty-state">
    <div class="empty-icon-wrap">
      <span class="material-symbols-rounded">task_alt</span>
    </div>
    <h3>No tasks found</h3>
    <p>{{ activeFilter() !== 'all' ? 'No tasks with this status. Try a different filter.' : 'Create your first task to
      get started.' }}</p>
    @if (activeFilter() === 'all') {
    <button class="btn btn-primary" style="margin-top: 16px;" (click)="openCreateModal()">
      <span class="material-symbols-rounded" style="font-size: 18px;">add</span>
      Create Task
    </button>
    }
  </div>
  } @else {

  <!-- List View -->
  @if (viewMode() === 'list') {
  <div class="task-list">
    @for (task of filteredTasks(); track task.id) {
    <div class="task-row" [class]="'task-status-' + task.status">
      <!-- Status indicator -->
      <div class="task-status-bar" [class]="getStatusConfig(task.status).color"></div>

      <!-- Main content -->
      <div class="task-main">
        <div class="task-top-row">
          <div class="task-title-section">
            <h3 class="task-title">{{ task.title }}</h3>
            <div class="task-badges">
              <span class="badge" [class]="'badge-' + getStatusConfig(task.status).color">
                <span class="material-symbols-rounded" style="font-size: 12px;">{{ getStatusConfig(task.status).icon
                  }}</span>
                {{ getStatusConfig(task.status).label }}
              </span>
              <span class="badge badge-type">
                <span class="material-symbols-rounded" style="font-size: 12px;">{{ getTypeConfig(task.task_type).icon
                  }}</span>
                {{ getTypeConfig(task.task_type).label }}
              </span>
            </div>
          </div>
          <div class="task-actions">
            <!-- Status dropdown -->
            <div class="status-dropdown">
              <select class="status-select" [ngModel]="task.status" (ngModelChange)="changeStatus(task, $event)">
                @for (opt of statusOptions; track opt.value) {
                <option [value]="opt.value">{{ opt.label }}</option>
                }
              </select>
            </div>
            <button class="btn-icon" title="Edit" (click)="openEditModal(task)">
              <span class="material-symbols-rounded">edit</span>
            </button>
            <button class="btn-icon btn-icon-danger" title="Delete" (click)="openDeleteConfirm(task)">
              <span class="material-symbols-rounded">delete</span>
            </button>
          </div>
        </div>

        @if (task.description) {
        <p class="task-desc">{{ task.description }}</p>
        }

        <div class="task-meta">
          @if (task.scheduled_time) {
          <span class="meta-chip">
            <span class="material-symbols-rounded" style="font-size: 14px;">schedule</span>
            {{ formatTime(task.scheduled_time) }}
          </span>
          }
          @if (task.scheduled_date) {
          <span class="meta-chip">
            <span class="material-symbols-rounded" style="font-size: 14px;">calendar_today</span>
            {{ task.task_type === 'monthly' ? 'Day ' + task.scheduled_date : formatDate(task.scheduled_date) }}
          </span>
          }
          @if (task.recurrence !== 'one_time') {
          <span class="meta-chip recurrence">
            <span class="material-symbols-rounded" style="font-size: 14px;">repeat</span>
            {{ getRecurrenceLabel(task.recurrence) }}
          </span>
          }
          <span class="meta-chip muted">
            <span class="material-symbols-rounded" style="font-size: 14px;">history</span>
            Created {{ formatDateTime(task.created_at) }}
          </span>
        </div>
      </div>
    </div>
    }
  </div>
  }

  <!-- Board View -->
  @if (viewMode() === 'board') {
  <div class="task-board" cdkDropListGroup>
    @for (status of statusOptions; track status.value) {
    <div class="board-column" [class]="'col-' + status.color">
      <div class="column-header">
        <div class="col-title">
          <span class="material-symbols-rounded">{{ status.icon }}</span>
          <h4>{{ status.label }}</h4>
          <span class="col-count">{{ getTasksByStatus(status.value).length }}</span>
        </div>
      </div>

      <div class="column-content" cdkDropList [id]="status.value" [cdkDropListData]="getTasksByStatus(status.value)"
        (cdkDropListDropped)="onTaskDrop($event)">
        @for (task of getTasksByStatus(status.value); track task.id) {
        <div class="board-card" cdkDrag [cdkDragData]="task" (click)="openEditModal(task)">
          <!-- Drag placeholder -->
          <div class="card-drag-placeholder" *cdkDragPlaceholder></div>

          <div class="card-top">
            <h5 class="card-title">{{ task.title }}</h5>
            <div class="card-actions" (click)="$event.stopPropagation()">
              <button class="btn-icon sm" (click)="openDeleteConfirm(task)">
                <span class="material-symbols-rounded">delete</span>
              </button>
            </div>
          </div>

          @if (task.description) {
          <p class="card-desc">{{ task.description }}</p>
          }

          <div class="card-footer">
            <span class="card-type-label">
              <span class="material-symbols-rounded">{{ getTypeConfig(task.task_type).icon }}</span>
              {{ getTypeConfig(task.task_type).label }}
            </span>
            @if (task.scheduled_time) {
            <span class="card-time">
              <span class="material-symbols-rounded">schedule</span>
              {{ formatTime(task.scheduled_time) }}
            </span>
            }
          </div>
        </div>
        }
      </div>
    </div>
    }
  </div>
  }

  }

  <!-- Create Modal -->
  @if (showCreateModal()) {
  <div class="modal-overlay" (click)="closeModals()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-row">
          <div class="modal-icon blue">
            <span class="material-symbols-rounded">add_task</span>
          </div>
          <h2>Create Task</h2>
        </div>
        <button class="btn-icon" (click)="closeModals()">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Title <span class="required">*</span></label>
          <input class="input" [(ngModel)]="taskForm.title" placeholder="e.g. Get morning news summary" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea class="input" [(ngModel)]="taskForm.description" rows="3"
            placeholder="Describe what this task should do..."></textarea>
        </div>

        <div class="form-divider"></div>
        <h4 class="form-section-title">
          <span class="material-symbols-rounded" style="font-size: 18px;">event_repeat</span>
          Schedule
        </h4>

        <div class="form-group">
          <label>Task Type</label>
          <div class="type-selector">
            @for (type of typeOptions; track type.value) {
            <button class="type-btn" [class.active]="taskForm.task_type === type.value"
              (click)="taskForm.task_type = type.value; onTaskTypeChange()">
              <span class="material-symbols-rounded" style="font-size: 18px;">{{ type.icon }}</span>
              {{ type.label }}
            </button>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group flex-1">
            <label>Time</label>
            <input type="time" class="input" [(ngModel)]="taskForm.scheduled_time" />
          </div>
          @if (taskForm.task_type === 'one_time') {
          <div class="form-group flex-1">
            <label>Date</label>
            <input type="date" class="input" [(ngModel)]="taskForm.scheduled_date" />
          </div>
          }
          @if (taskForm.task_type === 'monthly') {
          <div class="form-group flex-1">
            <label>Day of Month</label>
            <input type="number" class="input" [(ngModel)]="taskForm.scheduled_date" min="1" max="31"
              placeholder="1-31" />
          </div>
          }
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button class="btn btn-primary" (click)="createTask()" [disabled]="!taskForm.title.trim()">
          <span class="material-symbols-rounded" style="font-size: 18px;">check</span>
          Create Task
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Edit Modal -->
  @if (showEditModal()) {
  <div class="modal-overlay" (click)="closeModals()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title-row">
          <div class="modal-icon purple">
            <span class="material-symbols-rounded">edit_note</span>
          </div>
          <h2>Edit Task</h2>
        </div>
        <button class="btn-icon" (click)="closeModals()">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Title <span class="required">*</span></label>
          <input class="input" [(ngModel)]="taskForm.title" placeholder="Task title" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea class="input" [(ngModel)]="taskForm.description" rows="3"
            placeholder="Describe what this task should do..."></textarea>
        </div>

        <div class="form-divider"></div>
        <h4 class="form-section-title">
          <span class="material-symbols-rounded" style="font-size: 18px;">event_repeat</span>
          Schedule
        </h4>

        <div class="form-group">
          <label>Task Type</label>
          <div class="type-selector">
            @for (type of typeOptions; track type.value) {
            <button class="type-btn" [class.active]="taskForm.task_type === type.value"
              (click)="taskForm.task_type = type.value; onTaskTypeChange()">
              <span class="material-symbols-rounded" style="font-size: 18px;">{{ type.icon }}</span>
              {{ type.label }}
            </button>
            }
          </div>
        </div>

        <div class="form-row">
          <div class="form-group flex-1">
            <label>Time</label>
            <input type="time" class="input" [(ngModel)]="taskForm.scheduled_time" />
          </div>
          @if (taskForm.task_type === 'one_time') {
          <div class="form-group flex-1">
            <label>Date</label>
            <input type="date" class="input" [(ngModel)]="taskForm.scheduled_date" />
          </div>
          }
          @if (taskForm.task_type === 'monthly') {
          <div class="form-group flex-1">
            <label>Day of Month</label>
            <input type="number" class="input" [(ngModel)]="taskForm.scheduled_date" min="1" max="31"
              placeholder="1-31" />
          </div>
          }
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button class="btn btn-primary" (click)="updateTask()" [disabled]="!taskForm.title.trim()">
          <span class="material-symbols-rounded" style="font-size: 18px;">save</span>
          Save Changes
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Delete Confirmation -->
  @if (showDeleteConfirm()) {
  <div class="modal-overlay" (click)="closeModals()">
    <div class="modal modal-sm" (click)="$event.stopPropagation()">
      <div class="modal-body" style="text-align: center; padding: 32px 24px;">
        <div class="delete-icon-wrap">
          <span class="material-symbols-rounded">delete_forever</span>
        </div>
        <h3 style="margin: 16px 0 8px;">Delete Task?</h3>
        <p class="delete-desc">
          Are you sure you want to delete <strong>"{{ deletingTask?.title }}"</strong>? This action cannot be undone.
        </p>
      </div>
      <div class="modal-footer" style="justify-content: center;">
        <button class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button class="btn btn-danger" (click)="confirmDelete()">
          <span class="material-symbols-rounded" style="font-size: 18px;">delete</span>
          Delete
        </button>
      </div>
    </div>
  </div>
  }
</div>